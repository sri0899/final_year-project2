{% extends "base.html" %}
{% block title %}Models{% endblock %}
{% block content %}
<style>
.page { padding: 40px; max-width: 1300px; margin: 0 auto; }
h2 { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.sub { color: var(--muted); font-size: 14px; margin-bottom: 32px; }

.model-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 40px;
}

.model-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  position: relative;
  transition: all 0.2s;
}

.model-card.best {
  border-color: var(--accent);
  box-shadow: 0 0 30px rgba(56,189,248,0.1);
}

.best-badge {
  position: absolute; top: 16px; right: 16px;
  background: var(--accent);
  color: #060b18;
  font-size: 11px;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 20px;
}

.model-card h3 {
  font-family: 'Syne', sans-serif;
  font-size: 17px;
  margin-bottom: 20px;
}

.metric { margin-bottom: 14px; }
.metric-label { font-size: 12px; color: var(--muted); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.05em; }
.metric-value { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 700; }
.metric-bar-bg { height: 5px; background: var(--border); border-radius: 3px; margin-top: 6px; overflow: hidden; }
.metric-bar { height: 100%; border-radius: 3px; }

.confusion-section {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 28px;
  margin-bottom: 28px;
}

.confusion-section h3 {
  font-family: 'Syne', sans-serif;
  font-size: 18px;
  margin-bottom: 20px;
}

.cm-selector { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
.cm-btn {
  padding: 7px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  background: transparent;
  color: var(--muted);
  font-size: 13px;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  transition: all 0.2s;
}
.cm-btn:hover { border-color: var(--accent); color: var(--text); }
.cm-btn.active { background: var(--accent); color: #060b18; border-color: var(--accent); font-weight: 600; }

.scatter-section {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 28px;
}

.scatter-section h3 {
  font-family: 'Syne', sans-serif;
  font-size: 18px;
  margin-bottom: 16px;
}

.scatter-controls { display: flex; gap: 12px; margin-bottom: 20px; align-items: center; }
.scatter-controls label { font-size: 13px; color: var(--muted); }
.scatter-controls select {
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 7px 12px;
  border-radius: 8px;
  font-size: 13px;
  font-family: 'DM Sans', sans-serif;
}

.spinner { width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:40px auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.chart-img { width:100%; border-radius:10px; }
</style>

<div class="page">
  <h2>Model Performance</h2>
  <p class="sub">Comparison of 4 trained ML classifiers on the diabetes dataset</p>

  <!-- MODEL CARDS -->
  <div class="model-cards">
    {% for name, m in metrics.items() %}
    <div class="model-card {% if name == best %}best{% endif %}">
      {% if name == best %}<div class="best-badge">â˜… Best</div>{% endif %}
      <h3>{{ name }}</h3>
      
      <div class="metric">
        <div class="metric-label">Test Accuracy</div>
        <div class="metric-value" style="color:var(--accent)">{{ m.accuracy }}%</div>
        <div class="metric-bar-bg"><div class="metric-bar" style="width:{{ m.accuracy }}%;background:var(--accent)"></div></div>
      </div>
      
      <div class="metric">
        <div class="metric-label">ROC-AUC Score</div>
        <div class="metric-value" style="color:var(--purple)">{{ m.roc_auc }}%</div>
        <div class="metric-bar-bg"><div class="metric-bar" style="width:{{ m.roc_auc }}%;background:var(--purple)"></div></div>
      </div>
      
      <div class="metric">
        <div class="metric-label">5-Fold CV Score</div>
        <div class="metric-value" style="color:var(--success)">{{ m.cv_score }}%</div>
        <div class="metric-bar-bg"><div class="metric-bar" style="width:{{ m.cv_score }}%;background:var(--success)"></div></div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- CONFUSION MATRIX -->
  <div class="confusion-section">
    <h3>Confusion Matrix</h3>
    <div class="cm-selector">
      {% for name in metrics.keys() %}
      <button class="cm-btn {% if name == best %}active{% endif %}" data-model="{{ name }}" onclick="loadCM('{{ name }}')">{{ name }}</button>
      {% endfor %}
    </div>
    <div class="spinner" id="cm-spinner"></div>
    <img id="cm-img" class="chart-img" style="display:none;max-width:400px;margin:0 auto;display:none">
  </div>

  <!-- SCATTER EXPLORER -->
  <div class="scatter-section">
    <h3>Feature Scatter Explorer</h3>
    <div class="scatter-controls">
      <label>X-Axis:</label>
      <select id="sx" onchange="loadScatter()">
        <option>Glucose</option><option>BMI</option><option>Age</option>
        <option>Insulin</option><option>BloodPressure</option>
        <option>SkinThickness</option><option>DiabetesPedigreeFunction</option><option>Pregnancies</option>
      </select>
      <label>Y-Axis:</label>
      <select id="sy" onchange="loadScatter()">
        <option>BMI</option><option>Glucose</option><option>Age</option>
        <option>Insulin</option><option>BloodPressure</option>
        <option>SkinThickness</option><option>DiabetesPedigreeFunction</option><option>Pregnancies</option>
      </select>
    </div>
    <div class="spinner" id="sc-spinner"></div>
    <img id="sc-img" class="chart-img" style="display:none">
  </div>
</div>

<script>
let currentCM = "{{ best }}";

function loadCM(name) {
  document.querySelectorAll('.cm-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.cm-btn[data-model="${name}"]`).classList.add('active');
  const sp = document.getElementById('cm-spinner');
  const img = document.getElementById('cm-img');
  sp.style.display = 'block';
  img.style.display = 'none';
  fetch(`/api/chart/confusion/${encodeURIComponent(name)}`).then(r=>r.json()).then(d=>{
    img.src = 'data:image/png;base64,' + d.img;
    img.style.display = 'block';
    sp.style.display = 'none';
  });
}

function loadScatter() {
  const x = document.getElementById('sx').value;
  const y = document.getElementById('sy').value;
  const sp = document.getElementById('sc-spinner');
  const img = document.getElementById('sc-img');
  sp.style.display = 'block';
  img.style.display = 'none';
  fetch(`/api/chart/scatter?x=${x}&y=${y}`).then(r=>r.json()).then(d=>{
    img.src = 'data:image/png;base64,' + d.img;
    img.style.display = 'block';
    sp.style.display = 'none';
  });
}

// Initial loads
loadCM("{{ best }}");
loadScatter();
</script>
{% endblock %}
